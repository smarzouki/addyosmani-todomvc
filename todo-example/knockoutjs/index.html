<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Knockout.js</title>
    <link href="css/todos.css" media="all" rel="stylesheet" type="text/css" />
    <script src="js/knockout-2.0.0.js" type="text/javascript"></script>
</head>
<body>
    <div id="todoapp">
        <div class="title">
            <h1>Todos</h1>
        </div>
        <div class="content">
            <div id="create-todo">
                <input id="new-todo" data-bind="value: current, valueUpdate: 'afterkeydown', enterKey: add" placeholder="What needs to be done?" />
                <span class="ui-tooltip-top" style="display: none;">Press Enter to save this task</span>
            </div>
            <div id="todos">
                <ul id="todo-list" data-bind="foreach: todos">
                    <li data-bind="css: { editing: editing }">
                        <div class="todo" data-bind="css: { done : done }">
                            <div class="display">
                                <input class="check" type="checkbox" data-bind="checked: done" />
                                <div class="todo-content" data-bind="text: content, event: { dblclick: edit }" style="cursor: pointer;"></div>
                                <span class="todo-destroy" data-bind="click: $root.remove"></span>
                            </div>
                            <div class="edit">
                                <input class="todo-input" data-bind="value: content, valueUpdate: 'afterkeydown', enterKey: stopEditing, event: { blur: stopEditing }"/>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div id="todo-stats">
                <span class="todo-count" data-bind="visible: remainingCount">
                    <span class="number" data-bind="text: remainingCount"></span>
                    <span class="word" data-bind="text: getLabel(remainingCount)"></span> left.
                </span>
                <span class="todo-clear" data-bind="visible: completedCount">
                    <a href="#" data-bind="click: removeCompleted">
                        Clear <span class="number-done" data-bind="text: completedCount"></span>
                        completed <span class="word-done" data-bind="text: getLabel(completedCount)"></span>
                    </a>
                </span>
            </div>
        </div>
    </div>
    <ul id="instructions">
        <li data-bind="visible: todos().length">Double-click to edit a todo.</li>
    </ul>
    <div id="credits">
        Created by
        <br />
        <a href="http://jgn.me/">J&eacute;r&ocirc;me Gravel-Niquet</a>
        <br />
        Modified to use knockout.js by
        <br />
        <a href="https://github.com/ashish01/knockoutjs-todos">Ashish Sharma</a>
        <br/>
        Updated to use knockout.js 2.0 by
        <br/>
        <a href="http://knockmeout.net">Ryan Niemeyer</a>
        <br />
        Patches/fixes for cross-browser compat:
        <br />
        <a href="http://twitter.com/addyosmani">Addy Osmani</a>
    </div>

    <script type="text/javascript">
        (function() {
            //represent a single todo item
            var Todo = function (text) {
                this.content = ko.observable(text);
                this.done = ko.observable(false);
                this.editing = ko.observable(false);
            };

            //can place methods on prototype, as there can be many todos
            ko.utils.extend(Todo.prototype, {
                edit: function() {  this.editing(true); },
                stopEditing: function() { this.editing(false); }
            });


            //our main view model
            var ViewModel = function() {
                var self = this;
                this.todos = ko.observableArray();
                this.current = ko.observable();

                //add a new todo, when enter key is pressed
                this.add = function (data, event) {
                    var newTodo = new Todo(self.current());
                    self.todos.push(newTodo);
                    self.current("");
                };

                //remove a single todo
                this.remove = function (todo) {
                    self.todos.remove(todo);
                };

                //remove all completed todos
                this.removeCompleted = function () {
                    self.todos.remove(function(todo) {
                        return todo.done();
                    });
                };

                //count of all completed todos
                this.completedCount = ko.computed(function () {
                    return ko.utils.arrayFilter(self.todos(), function(todo) {
                        return todo.done();
                    }).length;
                });

                //count of todos that are not complete
                this.remainingCount = ko.computed(function () {
                    return self.todos().length - self.completedCount();
                });

                //helper function to keep expressions out of markup
                this.getLabel = function(count) {
                    return ko.utils.unwrapObservable(count) === 1 ? "item" : "items";
                };
            };


            //a custom binding to handle the enter key (could go in a separate library)
            ko.bindingHandlers.enterKey = {
                init: function(element, valueAccessor, allBindingsAccessor, data) {
                    var wrappedHandler, newValueAccessor;

                    //wrap the handler with a check for the enter key
                    wrappedHandler = function(data, event) {
                        if (event.keyCode === 13) {
                            valueAccessor().call(this, data, event);
                        }
                    };

                    //create a valueAccessor with the options that we would want to pass to the event binding
                    newValueAccessor = function() {
                        return { keyup: wrappedHandler };
                    };

                    //call the real event binding's init function
                    ko.bindingHandlers.event.init(element, newValueAccessor, allBindingsAccessor, data);
                }
            };


            //bind a new instance of our view model to the page
            ko.applyBindings(new ViewModel());
        })();
    </script>
</body>
</html>