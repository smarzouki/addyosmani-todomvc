<!DOCTYPE html>
<html>

  <head>
    <title>Dojo</title>
	<style type="text/css">
			@import "/code/dtk/dojotoolkit/dijit/themes/claro/claro.css";
	</style>
    <link href="css/todos.css" media="all" rel="stylesheet" type="text/css"/>
    <script data-dojo-config="async:true, parseOnLoad:true, paths:{'todo':'../../todo'}" src="./js/dtk/dojo/dojo.js"></script>
    <script>
        require(["dojo/parser", "dojo/dom-class", "dojo/_base/array", "dojox/mvc", "dojox/mvc/Group", 
            "dojox/mvc/Repeat", "dojox/mvc/Output", "dijit/InlineEditBox", "todo/form/CheckBox"], 
		function (parser, domClass, array, mvc) {
            var data = {
                todos : [],
                incomplete: 0,
                complete: 0
            };

            window.model = mvc.newStatefulModel({ data : data });

            mvc.bind(model.incomplete, "value", model.complete, "value", function (value) {
                return this.model.todos.get("length") - value;
            });

            mvc.bindInputs([model.incomplete], function () {
                domClass[model.todos.get("length") ? "add" : "remove" ]("todo-stats", "items_present");
            });

            mvc.bindInputs([model.complete], function () {
                domClass[model.complete.value > 0 ? "add" : "remove" ]("todo-stats", "items_selected");
            });


            var updateTotalItemsLeft = function () {
                var remaining = 0;

                array.forEach(model.todos, function (item) {
                    item && !item.isDone.value && remaining++;
                });

                model.incomplete.set("value", remaining);
            };
            
            model.todos.watch(updateTotalItemsLeft);

            var addToModel = function (content, isDone) {
                var insert = mvc.newStatefulModel({
                    data: {content: content, isDone: isDone} 
				});

                mvc.bindInputs([insert.isDone], updateTotalItemsLeft);
				model.todos.add(model.todos.length, insert);
            }

            window.addTodoItem = function (input, event) {
                if (event.keyCode !== 13) return;

                addToModel(input.value, false);

                input.value = "";
			};

            window.removeCompletedItems = function () {
                var len = model.todos.length, idx = 0;

                while (idx < len) {
                    if (model.todos[idx].isDone.value) {
                        model.todos.remove(idx);
                        len--;
                        continue;                        
                    }

                    idx++; 
                };
            };
        });
    </script>
  </head>

  <body class="claro">

    <!-- Todo App Interface -->

    <div id="todoapp">

      <div class="title">
        <h1>Todos</h1>
      </div>

      <div class="content">

        <div id="create-todo">
          <input id="new-todo" placeholder="What needs to be done?" type="text" onkeypress="addTodoItem(this, event)"/>
          <span class="ui-tooltip-top" style="display:none;">Press Enter to save this task</span>
        </div>

        <div id="todos">
            <ul id="todo-list" data-dojo-type="dojox.mvc.Repeat" data-dojo-props="ref: 'model.todos'">
                <li data-dojo-type="dojox.mvc.Group" data-dojo-props="ref: '${this.index}'">
                    <div class="todo">
                        <input class="check" data-dojo-type="todo.form.CheckBox" data-dojo-props='ref: "isDone"' style="display:inline-block" >
                        </input>
                        <div class="todo-content dijitInline" data-dojo-type="dijit.InlineEditBox"  
                            data-dojo-props='ref: "content", editor:"dijit.form.TextBox", autosave:true, width:"420px", style:"width:420px;"'></div>

                        <span class="todo-destroy" data-model-id="${this.index}" onclick="model.todos.remove(this.dataset.modelId)">
                        </span>
                    </div>
                </li>
            </ul>
        </div>

        <div id="todo-stats">
            <span class="todo-count">
                <span data-dojo-type="dojox.mvc.Output" data-dojo-props="ref: model.incomplete" class="number"></span>
                <span class="word">items</span> left.
            </span>
            <span class="todo-clear">
                <a href="#" onclick="removeCompletedItems()">
                    Clear 
                    <span class="number-done" data-dojo-type="dojox.mvc.Output" data-dojo-props="ref: model.complete" ></span>
                    completed items
                </a>
            </span>

        </div>
      </div>

    </div>

  
    <div id="credits">
      Created by
      <br />
      <a href="http://jamesthom.as/">James Thomas</a>. 
    </div>
  </body>

</html>
