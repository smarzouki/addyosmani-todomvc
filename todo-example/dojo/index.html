<!DOCTYPE html>
<html>

  <head>
    <title>Dojo</title>
	<style type="text/css">
			@import "./css/claro.css";
	</style>
    <link href="css/todos.css" media="all" rel="stylesheet" type="text/css"/>
    <script data-dojo-config="async:true, parseOnLoad:true, paths:{'todo':'../../todo'}" src="./js/dtk/dojo/dojo.js"></script> 
    <script>
        require(["dojo/parser", "dojo/dom-class", "dojo/_base/array", "dojox/mvc", "todo/store/LocalStorage", 
            "dojox/mvc/Group", "dojox/mvc/Repeat", "dojox/mvc/Output", "dijit/InlineEditBox", "todo/form/CheckBox"], 
		function (parser, domClass, array, mvc, localStorage) {
            /** 
            * Initialise our custom dojo store, backed by localStorage. This will be 
            * used to read the initial items, if available, and persist the current items
            * when the application finishes.
            */
            var store = new localStorage();

            /**
             * Attempt to read todo items from localStorage,
             * returning default value the first time the application
             * is loaded... The "id" parameter is used as the unique 
             * localStorage key for this object.
             */
            var getLocalStorageItems = function () {
                var initial = {
                    id: "local_storage_todos",
                    todos : [],
                    incomplete: 0,
                    complete: 0
                };
                 
                return store.get(initial.id) || initial;
            };
            
            /**
             * Update the model's "incomplete" value with the
             * total number of items not finished. This will automatically
             * cause the bound "complete" value to be updated as well.
             */
            var updateTotalItemsLeft = function () {
                var remaining = 0;

                array.forEach(model.todos, function (item) {
                    item && !item.isDone.value && remaining++;
                });

                model.incomplete.set("value", remaining);
            };
           
            /**
             * Add new a new todo item as the last element 
             * in the parent model.
             * Set up bindings to the checkbox value, changes 
             * should automatically update total items left.
             */
            var addToModel = function (content, isDone) {
                var insert = mvc.newStatefulModel({
                    data: {content: content, isDone: isDone} 
				});

                bindIsDone(insert);
				model.todos.add(model.todos.length, insert);
            }
    
            /** 
             * Set up binding on a todo item, so that when the
             * item's checked attribute changes, we re-calculate
             * the composite model attribute's value, "complete". 
             */
            var bindIsDone = function (item) {
                mvc.bindInputs([item.isDone], updateTotalItemsLeft);
            }

            /**
             * Create new application Model class, this will be used to bind
             * the UI elements to the data store items. Pre-populate model with
             * items from localStorage if they exist...
             */
            window.model = mvc.newStatefulModel({ data : getLocalStorageItems() });

            /** 
             * Set up a composite model attribute, "complete", that is automatically 
             * calculated whenever the "incomplete" source value is modified. The "complete" 
             * attribute is bound to a view widget, displaying the number of items that can
             * be cleared using the link. 
             */
            mvc.bind(model.incomplete, "value", model.complete, "value", function (value) {
                return this.model.todos.get("length") - value;
            });

            /**
             * The methods below set up a function binding to the composite (complete & incomplete) 
             * model attributes. These values are used to append CSS classes to dynamically show & hide
             * the "stats" elements when the model is non-empty and has some completed items. Whenever 
             * the values below are updated, the function will be executed.
             */
            mvc.bindInputs([model.incomplete], function () {
                domClass[model.todos.get("length") ? "add" : "remove" ]("todo-stats", "items_present");
            });

            mvc.bindInputs([model.complete], function () {
                domClass[model.complete.value > 0 ? "add" : "remove" ]("todo-stats", "items_selected");
            });

            /** 
             * Bind all pre-populated todo items to update the 
             * total item values when the "isDone" attribute is changed.
             */
            array.forEach(model.todos, bindIsDone);

            /**
             * Whenever the "todos" array is modified, an element is added
             * or deleted, we need to recompute the model composite values.
             * Binding attributes changes to the "updateTotalItemsLeft" function
             * using "watch", an attribute on dojo.Stateful objects.
             */
            model.todos.watch(updateTotalItemsLeft);

            /** 
             * Update the stats panel for the pre-populated
             * items that may have been retrieved from localStorage
             */
            updateTotalItemsLeft();

            /** 
             * Global event handlers, used to process user events
             * (add item, remove item) generated by the views.
             */
            window.addTodoItem = function (input, event) {
                if (event.keyCode !== 13) return;

                addToModel(input.value, false);
                input.value = "";
			};

            /**
             * Remove all items that have been completed from
             * model. We have to individually check each todo 
             * item, removing if true.
             */
            window.removeCompletedItems = function () {
                var len = model.todos.length, idx = 0;

                /** 
                 * Removing array indices from a Dojo MVC Model
                 * array left-shifts the remaining items. When 
                 * we find an item to remove, don't increment the 
                 * index and, instead, decrement the total item count.
                 */
                while (idx < len) {
                    if (model.todos[idx].isDone.value) {
                        model.todos.remove(idx);
                        len--;
                        continue;                        
                    }

                    idx++; 
                };
            };

            /** 
             * Hook into unload event to trigger persisting
             * of the current model contents into the localStorage
             * backed data store.
             */
            window.onbeforeunload = function () {
                model.commit(store);
            };

        });
    </script>
  </head>

  <body class="claro">

    <!-- Todo App Interface -->

    <div id="todoapp">

      <div class="title">
        <h1>Todos</h1>
      </div>

      <div class="content">

        <div id="create-todo">
          <input id="new-todo" placeholder="What needs to be done?" type="text" onkeypress="addTodoItem(this, event)"/>
          <span class="ui-tooltip-top" style="display:none;">Press Enter to save this task</span>
        </div>

        <div id="todos">
            <ul id="todo-list" data-dojo-type="dojox.mvc.Repeat" data-dojo-props="ref: 'model.todos'">
                <li data-dojo-type="dojox.mvc.Group" data-dojo-props="ref: '${this.index}'">
                    <div class="todo">
                        <input class="check" data-dojo-type="todo.form.CheckBox" data-dojo-props='ref: "isDone"' style="display:inline-block" >
                        </input>
                        <div class="todo-content dijitInline" data-dojo-type="dijit.InlineEditBox"  
                            data-dojo-props='ref: "content", editor:"dijit.form.TextBox", autosave:true, width:"420px", style:"width:420px;"'></div>

                        <span class="todo-destroy" data-model-id="${this.index}" onclick="model.todos.remove(this.dataset.modelId)">
                        </span>
                    </div>
                </li>
            </ul>
        </div>

        <div id="todo-stats">
            <span class="todo-count">
                <span data-dojo-type="dojox.mvc.Output" data-dojo-props="ref: model.incomplete" class="number"></span>
                <span class="word">items</span> left.
            </span>
            <span class="todo-clear">
                <a href="#" onclick="removeCompletedItems()">
                    Clear 
                    <span class="number-done" data-dojo-type="dojox.mvc.Output" data-dojo-props="ref: model.complete" ></span>
                    completed items
                </a>
            </span>

        </div>
      </div>

    </div>

  
    <div id="credits">
      Created by
      <br />
      <a href="http://jamesthom.as/">James Thomas</a> and <a href="https://github.com/edchat">Ed Chatelain</a>. 
    </div>
  </body>

</html>
