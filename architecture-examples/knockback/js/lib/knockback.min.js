// Generated by CoffeeScript 1.3.1
/*
 knockback.js 0.15.1
 (c) 2011 Kevin Malakoff.
 Knockback.js is freely distributable under the MIT license.
 See the following for full license details:
 https://github.com/kmalakoff/knockback/blob/master/LICENSE
 Dependencies: Knockout.js, Backbone.js, and Underscore.js.
 Optional dependency: Backbone.ModelRef.js.
*/
var Backbone,Knockback,kb,ko,_;if(typeof exports!=="undefined"){Knockback=kb=exports}else{this.Knockback=this.kb={}}Knockback.VERSION="0.15.1";_=!this._&&(typeof require!=="undefined")?require("underscore"):this._;Backbone=!this.Backbone&&(typeof require!=="undefined")?require("backbone"):this.Backbone;ko=!this.ko&&(typeof require!=="undefined")?require("knockout"):this.ko;Knockback.locale_manager;Knockback.stats={collection_observables:0,view_models:0};Knockback.stats_on=false;Knockback.utils={};Knockback.utils.legacyWarning=function(a,d,c){var b;kb._legacy_warnings||(kb._legacy_warnings={});(b=kb._legacy_warnings)[a]||(b[a]=0);kb._legacy_warnings[a]++;return console.warn("Legacy warning! '"+a+"' has been deprecated (will be removed in Knockback "+d+"). "+c+".")};Knockback.utils.wrappedObservable=function(a,b){if(arguments.length===1){if(!(a&&a.__kb&&a.__kb.observable)){throw new Error("Knockback: instance is not wrapping an observable")}return a.__kb.observable}if(!a){throw new Error("Knockback: no instance for wrapping a observable")}a.__kb||(a.__kb={});if(a.__kb.observable&&a.__kb.observable.__kb){a.__kb.observable.__kb.instance=null}a.__kb.observable=b;if(b){b.__kb||(b.__kb={});b.__kb.instance=a}return b};Knockback.wrappedObservable=function(a){kb.utils.legacyWarning("kb.wrappedObservable","0.16.0","Please use kb.utils.wrappedObservable instead");return kb.utils.wrappedObservable(a)};Knockback.utils.observableInstanceOf=function(b,a){if(!b){return false}if(!(b.__kb&&b.__kb.instance)){return false}return b.__kb.instance instanceof a};Knockback.utils.wrappedModel=function(a,b){if(arguments.length===1){if(a&&a.__kb&&a.__kb.hasOwnProperty("model")){return a.__kb.model}else{return a}}if(!a){throw new Error("Knockback: no view_model for wrapping a model")}a.__kb||(a.__kb={});a.__kb.model=b;return b};Knockback.viewModelGetModel=Knockback.vmModel=function(a){kb.utils.legacyWarning("kb.vmModel","0.16.0","Please use kb.utils.wrappedModel instead");return kb.utils.wrappedModel(a)};Knockback.utils.setToDefault=function(d){var b,c,a;if(!d){return}if(ko.isObservable(d)){return typeof d.setToDefault==="function"?d.setToDefault():void 0}else{if(_.isObject(d)){a=[];for(b in d){c=d[b];a.push(c&&(b!=="__kb")?kb.utils.setToDefault(c):void 0)}return a}}};Knockback.vmSetToDefault=function(a){kb.utils.legacyWarning("kb.vmSetToDefault","0.16.0","Please use kb.utils.release instead");return kb.utils.setToDefault(a)};Knockback.utils.release=function(c){var a,b;if(!c){return false}if(ko.isObservable(c)||(c instanceof kb.Observables)||(typeof c.release==="function")||(typeof c.destroy==="function")){if(c.release){c.release()}else{if(c.destroy){c.destroy()}else{if(c.dispose){c.dispose()}}}return true}else{if(_.isObject(c)&&!(typeof c==="function")){for(a in c){b=c[a];if(!b||(a==="__kb")){continue}if(kb.utils.release(b)){c[a]=null}}return true}}return false};Knockback.vmRelease=function(a){kb.utils.legacyWarning("kb.vmRelease","0.16.0","Please use kb.utils.release instead");return kb.utils.release(a)};Knockback.vmReleaseObservable=function(a){kb.utils.legacyWarning("kb.vmReleaseObservable","0.16.0","Please use kb.utils.release instead");return kb.utils.release(a)};kb.utils.optionsCreateClear=function(a){delete a.create;delete a.children;delete a.view_model;return delete a.view_model_create};kb.utils.optionsCreateOverride=function(a,b){kb.utils.optionsCreateClear(a);return _.extend(a,b)};Knockback.RefCountable=(function(){a.name="RefCountable";a.extend=Backbone.Model.extend;function a(){this.__kb||(this.__kb={});this.__kb.ref_count=1}a.prototype.__destroy=function(){};a.prototype.retain=function(){if(this.__kb.ref_count<=0){throw new Error("RefCountable: ref_count is corrupt: "+this.__kb.ref_count)}this.__kb.ref_count++;return this};a.prototype.release=function(){if(this.__kb.ref_count<=0){throw new Error("RefCountable: ref_count is corrupt: "+this.__kb.ref_count)}this.__kb.ref_count--;if(!this.__kb.ref_count){this.__destroy()}return this};a.prototype.refCount=function(){return this.__kb.ref_count};return a})();Knockback.Store=(function(){a.name="Store";function a(){this.keys=[];this.values=[]}a.prototype.destroy=function(){var c,e,d,b;this.keys=null;d=this.values;for(c in d){e=d[c];if(!kb.utils.observableInstanceOf(e,kb.CollectionObservable)){continue}this.values[c]=null;while(e.refCount()>0){e.release()}}b=this.values;for(c in b){e=b[c];if(!e){continue}this.values[c]=null;if(e instanceof kb.RefCountable){while(e.refCount()>0){e.release()}}else{kb.utils.release(e)}}return this.values=null};a.prototype.registerValue=function(c,d){var b;if(d instanceof kb.RefCountable){d.retain()}b=_.indexOf(this.keys,c);if(b>=0){this.values[b]=d}else{this.keys.push(c);this.values.push(d)}return d};a.prototype.resolveValue=function(d,f,c){var b,e;b=_.indexOf(this.keys,d);if(b>=0){if(this.values[b]){if((this.values[b] instanceof kb.RefCountable)&&(this.values[b].refCount()<=0)){this.values[b]=null}else{if(this.values[b] instanceof kb.RefCountable){return this.values[b].retain()}else{return this.values[b]}}}}else{b=this.keys.length;this.keys.push(d);this.values.push(void 0)}e=f.apply(null,Array.prototype.slice.call(arguments,2));if(this.keys[b]!==d){this.registerValue(d,e)}else{if(!this.values[b]){if(e instanceof kb.RefCountable){e.retain()}this.values[b]=e}}return e};a.prototype.releaseValue=function(c){var b;if(!(c instanceof kb.RefCountable)){return}c.release();if(c.refCount()>0){return}b=_.indexOf(this.values,c);if(!(b>=0)){return}return this.values[b]=0};a.prototype.addResolverToOptions=function(b,c){return _.extend(b,{store:this,store_key:c})};a.resolveFromOptions=function(b,c){if(!(b.store&&b.store_key)){return}return b.store.registerValue(b.store_key,c)};return a})();var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Knockback.CollectionObservable=(function(b){__extends(a,b);a.name="CollectionObservable";function a(f,c){var e,d,g=this;if(c==null){c={}}if(!f){throw new Error("CollectionObservable: collection is missing")}a.__super__.constructor.apply(this,arguments);if(Knockback.stats_on){kb.stats.collection_observables++}if(ko.isObservable(c)&&c.hasOwnProperty("indexOf")){kb.utils.legacyWarning("kb.collectionObservable with an external ko.observableArray","0.16.0","Please use the kb.collectionObservable directly instead of passing a ko.observableArray");d=kb.utils.wrappedObservable(this,c);c=arguments[2]||{};e=true}else{d=kb.utils.wrappedObservable(this,ko.observableArray([]))}if(!c.store_skip_resolve){kb.Store.resolveFromOptions(c,kb.utils.wrappedObservable(this))}if(c.store){this.__kb.store=c.store}else{this.__kb.store=new kb.Store();this.__kb.store_is_owned=true}if(c.hasOwnProperty("view_model")){if(!c.view_model){throw new Error("Knockback.CollectionObservable: options.view_model is empty")}this.view_model_create_fn=c.view_model;this.view_model_create_with_new=true}else{if(c.hasOwnProperty("view_model_constructor")){if(!c.view_model_constructor){throw new Error("Knockback.CollectionObservable: options.view_model_constructor is empty")}kb.utils.legacyWarning("kb.collectionObservable option view_model_constructor","0.16.0","Please use view_model option instead");this.view_model_create_fn=c.view_model_constructor;this.view_model_create_with_new=true}else{if(c.hasOwnProperty("view_model_create")){if(!c.view_model_create){throw new Error("Knockback.CollectionObservable: options.view_model_create is empty")}this.view_model_create_fn=c.view_model_create}else{if(c.hasOwnProperty("create")){if(!c.create){throw new Error("Knockback.CollectionObservable: options.create is empty")}this.view_model_create_fn=c.create}}}}this.sort_attribute=c.sort_attribute;this.sorted_index=c.sorted_index;this.__kb._onCollectionReset=_.bind(this._onCollectionReset,this);this.__kb._onCollectionResort=_.bind(this._onCollectionResort,this);this.__kb._onModelAdd=_.bind(this._onModelAdd,this);this.__kb._onModelRemove=_.bind(this._onModelRemove,this);this.__kb._onModelChange=_.bind(this._onModelChange,this);if(e&&f){f.bind("change",function(){return kb.utils.wrappedObservable(g).valueHasMutated()})}d.retain=_.bind(this.retain,this);d.refCount=_.bind(this.refCount,this);d.release=_.bind(this.release,this);d.collection=_.bind(this.collection,this);d.viewModelByModel=_.bind(this.viewModelByModel,this);d.sortedIndex=_.bind(this.sortedIndex,this);d.sortAttribute=_.bind(this.sortAttribute,this);d.hasViewModels=_.bind(this.hasViewModels,this);d.bind=_.bind(this.bind,this);d.unbind=_.bind(this.unbind,this);d.trigger=_.bind(this.trigger,this);this.collection(f,{silent:true,defer:c.defer});return d}a.prototype.__destroy=function(){this.collection(null);if(this.hasViewModels()&&this.__kb.store_is_owned){this.__kb.store.destroy();this.__kb.store=null}this.view_model_create_fn=null;this.__kb.collection=null;kb.utils.wrappedObservable(this,null);a.__super__.__destroy.apply(this,arguments);if(Knockback.stats_on){return kb.stats.collection_observables--}};a.prototype.retain=function(){a.__super__.retain.apply(this,arguments);return kb.utils.wrappedObservable(this)};a.prototype.release=function(){var c;c=kb.utils.wrappedObservable(this);a.__super__.release.apply(this,arguments);return c};a.prototype.collection=function(g,c){var f,d,e;f=kb.utils.wrappedObservable(this);if(arguments.length===0){f();return this.__kb.collection}if(g===this.__kb.collection){return}if(this.__kb.collection){this._clear();this._collectionUnbind(this.__kb.collection);if(typeof(d=this.__kb.collection).release==="function"){d.release()}this.__kb.collection=null}this.__kb.collection=g;if(this.__kb.collection){if(typeof(e=this.__kb.collection).retain==="function"){e.retain()}this._collectionBind(this.__kb.collection);return this.sortedIndex(this.sorted_index,this.sort_attribute,c)}};a.prototype.sortedIndex=function(g,c,d){var e,f=this;if(d==null){d={}}if(g){this.sorted_index=g;this.sort_attribute=c}else{if(c){this.sort_attribute=c;this.sorted_index=this._sortAttributeFn(c)}else{this.sort_attribute=null;this.sorted_index=null}}e=function(){var h;h=kb.utils.wrappedObservable(f);if((f.__kb.collection.models.length===0)&&(h().length===0)){return}f._collectionResync(true);if(!d.silent){return f.trigger("resort",h())}};if(d.defer){_.defer(e)}else{e()}return this};a.prototype.sortAttribute=function(d,e,c){return this.sortedIndex(e,d,c)};a.prototype.viewModelByModel=function(d){var c,e;if(!this.hasViewModels()){return null}e=kb.utils.wrappedObservable(this);c=d.hasOwnProperty(d.idAttribute)?d.idAttribute:"cid";return _.find(e(),function(f){return f.__kb.model[c]===d[c]})};a.prototype.hasViewModels=function(){return !!this.view_model_create_fn};a.prototype._collectionBind=function(j){var g,i,f,e,d,h,c;if(!j){return}j.bind("reset",this.__kb._onCollectionReset);if(!this.sorted_index){j.bind("resort",this.__kb._onCollectionResort)}h=["new","add"];for(i=0,e=h.length;i<e;i++){g=h[i];j.bind(g,this.__kb._onModelAdd)}c=["remove","destroy"];for(f=0,d=c.length;f<d;f++){g=c[f];j.bind(g,this.__kb._onModelRemove)}return j.bind("change",this.__kb._onModelChange)};a.prototype._collectionUnbind=function(j){var g,i,f,e,d,h,c;if(!j){return}j.unbind("reset",this.__kb._onCollectionReset);if(!this.sorted_index){j.unbind("resort",this.__kb._onCollectionResort)}h=["new","add"];for(i=0,e=h.length;i<e;i++){g=h[i];j.unbind(g,this.__kb._onModelAdd)}c=["remove","destroy"];for(f=0,d=c.length;f<d;f++){g=c[f];j.unbind(g,this.__kb._onModelRemove)}return j.unbind("change",this.__kb._onModelChange)};a.prototype._onCollectionReset=function(){return this._collectionResync()};a.prototype._onCollectionResort=function(d){var c;if(this.sorted_index){throw new Error("CollectionObservable: collection sorted_index unexpected")}if(_.isArray(d)){c=kb.utils.wrappedObservable(this);return this.trigger("resort",c())}else{return this._onModelResort(d)}};a.prototype._onModelAdd=function(d){var c,f,e;e=this.hasViewModels()?this._createTarget(d):d;f=kb.utils.wrappedObservable(this);if(this.sorted_index){c=this.sorted_index(f(),e)}else{c=this.__kb.collection.indexOf(d)}f.splice(c,0,e);return this.trigger("add",e,f())};a.prototype._onModelRemove=function(c){var e,d;d=this.hasViewModels()?this.viewModelByModel(c):c;if(!d){return}e=kb.utils.wrappedObservable(this);e.remove(d);this.trigger("remove",d,e);if(this.hasViewModels()){return this.__kb.store.releaseValue(d)}};a.prototype._onModelChange=function(c){if(this.sorted_index&&(!this.sort_attribute||c.hasChanged(this.sort_attribute))){return this._onModelResort(c)}};a.prototype._onModelResort=function(d){var c,g,f,h,e;g=kb.utils.wrappedObservable(this);e=this.hasViewModels()?this.viewModelByModel(d):d;f=g.indexOf(e);if(this.sorted_index){h=_.clone(g());h.splice(f,1);c=this.sorted_index(h,e)}else{c=this.__kb.collection.indexOf(d)}if(f===c){return}g.splice(f,1);g.splice(c,0,e);return this.trigger("resort",e,g(),c)};a.prototype._clear=function(f){var i,h,e,g,d,c;i=kb.utils.wrappedObservable(this);if(!f){this.trigger("remove",i())}e=i.removeAll();if(this.hasViewModels()){c=[];for(g=0,d=e.length;g<d;g++){h=e[g];c.push(this.__kb.store.releaseValue(h))}return c}};a.prototype._collectionResync=function(k){var d,g,c,j,i,e,l,f,h=this;this._clear(k);c=kb.utils.wrappedObservable(this);if(this.sorted_index){i=[];f=this.__kb.collection.models;for(e=0,l=f.length;e<l;e++){g=f[e];j=this._createTarget(g);d=this.sorted_index(i,j);i.splice(d,0,j)}}else{i=this.hasViewModels()?_.map(this.__kb.collection.models,function(m){return h._createTarget(m)}):_.clone(this.__kb.collection.models)}c(i);if(!k){return this.trigger("add",c())}};a.prototype._sortAttributeFn=function(c){if(this.hasViewModels()){return function(e,d){return _.sortedIndex(e,d,function(f){return kb.utils.wrappedModel(f).get(c)})}}else{return function(e,d){return _.sortedIndex(e,d,function(f){return f.get(c)})}}};a.prototype._createTarget=function(c){var e,d=this;e=function(){var h,g,f;g=d.__kb.store.addResolverToOptions({},c);h=kb.utils.wrappedObservable(d);f=d.view_model_create_with_new?new d.view_model_create_fn(c,g,h):d.view_model_create_fn(c,g,h);kb.utils.wrappedModel(f,c);return f};if(this.hasViewModels()){return this.__kb.store.resolveValue(c,e)}else{return c}};return a})(kb.RefCountable);__extends(Knockback.CollectionObservable.prototype,Backbone.Events);Knockback.collectionObservable=function(c,b,a){return new Knockback.CollectionObservable(c,b,a)};Knockback.sortedIndexWrapAttr=Knockback.siwa=function(a,b){return function(d,c){return _.sortedIndex(d,c,function(e){return new b(kb.utils.wrappedModel(e).get(a))})}};if(!this.Knockback){throw new Error("Knockback: Dependency alert! knockback_core.js must be included before this file")}Knockback.DefaultWrapper=(function(){a.name="DefaultWrapper";function a(b,e){var c,d=this;this.default_value_observable=e;this.__kb={};c=kb.utils.wrappedObservable(this,ko.dependentObservable({read:function(){var g,f;f=ko.utils.unwrapObservable(b());g=ko.utils.unwrapObservable(d.default_value_observable);if(!f){return g}else{return f}},write:function(f){return b(f)}}));c.destroy=_.bind(this.destroy,this);c.setToDefault=_.bind(this.setToDefault,this);return c}a.prototype.destroy=function(){kb.utils.wrappedObservable(this,null);return this.default_value=null};a.prototype.setToDefault=function(){var b;b=kb.utils.wrappedObservable(this);return b(this.default_value_observable)};return a})();Knockback.defaultWrapper=function(b,a){return new Knockback.DefaultWrapper(b,a)};Knockback.toFormattedString=function(g){var b,e,d,c,a,f;a=g.slice();e=Array.prototype.slice.call(arguments,1);for(d in e){b=e[d];f=ko.utils.unwrapObservable(b);if(!f){f=""}c=g.indexOf("{"+d+"}");while(c>=0){a=a.replace("{"+d+"}",f);c=g.indexOf("{"+d+"}",c+1)}}return a};Knockback.parseFormattedString=function(h,m){var i,a,j,k,g,p,o,f,l,b,e,n,d,c;b=m.slice();j=0;p=0;f={};while(b.search("\\{"+j+"\\}")>=0){o=m.indexOf("{"+j+"}");while(o>=0){b=b.replace("{"+j+"}","(.*)");f[o]=j;p++;o=m.indexOf("{"+j+"}",o+1)}j++}i=j;l=new RegExp(b);g=l.exec(h);if(g){g.shift()}if(!g||(g.length!==p)){return _.map((function(){c=[];for(var q=1;1<=i?q<=i:q>=i;1<=i?q++:q--){c.push(q)}return c}).apply(this),function(){return""})}n=_.sortBy(_.keys(f),function(q,r){return parseInt(q,10)});a={};for(k in n){o=n[k];j=f[o];if(a.hasOwnProperty(j)){continue}a[j]=k}e=[];j=0;while(j<i){e.push(g[a[j]]);j++}return e};Knockback.FormattedObservable=(function(){a.name="FormattedObservable";function a(e,c){var d,b;this.__kb={};if(_.isArray(c)){e=e;b=c}else{b=Array.prototype.slice.call(arguments,1)}d=kb.utils.wrappedObservable(this,ko.dependentObservable({read:function(){var f,h,g;c=[ko.utils.unwrapObservable(e)];for(h=0,g=b.length;h<g;h++){f=b[h];c.push(ko.utils.unwrapObservable(f))}return kb.toFormattedString.apply(null,c)},write:function(i){var g,h,j,f;h=kb.parseFormattedString(i,ko.utils.unwrapObservable(e));j=Math.min(b.length,h.length);g=0;f=[];while(g<j){b[g](h[g]);f.push(g++)}return f}}));return d}a.prototype.destroy=function(){return kb.utils.wrappedObservable(this,null)};return a})();Knockback.formattedObservable=function(b,a){return new Knockback.FormattedObservable(b,Array.prototype.slice.call(arguments,1))};Knockback.LocalizedObservable=(function(){a.name="LocalizedObservable";a.extend=Backbone.Model.extend;function a(d,c,b){var e;this.value=d;this.options=c!=null?c:{};this.view_model=b!=null?b:{};if(!(this.options.read||this.read)){throw new Error("LocalizedObservable: options.read is missing")}if(this.options.read&&this.read){throw new Error("LocalizedObservable: options.read and read class function exist. You need to choose one.")}if(this.options.write&&this.write){throw new Error("LocalizedObservable: options.write and write class function exist. You need to choose one.")}if(!kb.locale_manager){throw new Error("LocalizedObservable: Knockback.locale_manager is not defined")}this.__kb={};this.__kb._onLocaleChange=_.bind(this._onLocaleChange,this);if(this.value){d=ko.utils.unwrapObservable(this.value)}this.__kb.value_observable=ko.observable(!d?this._getDefaultValue():this.read.call(this,d,null));if(this.write&&!(typeof this.write==="function")){throw new Error("LocalizedObservable: options.write is not a function for read_write model attribute")}e=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this._onGetValue,this),write:this.write?_.bind(this._onSetValue,this):(function(){throw new Error("Knockback.LocalizedObservable: value is read only")}),owner:this.view_model}));e.destroy=_.bind(this.destroy,this);e.observedValue=_.bind(this.observedValue,this);e.setToDefault=_.bind(this.setToDefault,this);e.resetToCurrent=_.bind(this.resetToCurrent,this);kb.locale_manager.bind("change",this.__kb._onLocaleChange);return e}a.prototype.destroy=function(){kb.locale_manager.unbind("change",this.__kb._onLocaleChange);this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.options={};this.view_model=null;return this.__kb=null};a.prototype.setToDefault=function(){var c,b;if(!this["default"]){return}b=this._getDefaultValue();c=this.__kb.value_observable();if(c!==b){return this._onSetValue(b)}else{return this.__kb.value_observable.valueHasMutated()}};a.prototype.resetToCurrent=function(){this.__kb.value_observable(null);return this._onSetValue(this._getCurrentValue())};a.prototype.observedValue=function(b){if(arguments.length===0){return this.value}this.value=b;this._onLocaleChange();return this};a.prototype._getDefaultValue=function(){if(!this["default"]){return""}if(typeof this["default"]==="function"){return this["default"]()}else{return this["default"]}};a.prototype._getCurrentValue=function(){var b;b=kb.utils.wrappedObservable(this);if(!(this.value&&b)){return this._getDefaultValue()}return this.read.call(this,ko.utils.unwrapObservable(this.value))};a.prototype._onGetValue=function(){if(this.value){ko.utils.unwrapObservable(this.value)}return this.__kb.value_observable()};a.prototype._onSetValue=function(b){this.write.call(this,b,ko.utils.unwrapObservable(this.value));b=this.read.call(this,ko.utils.unwrapObservable(this.value));this.__kb.value_observable(b);if(this.options.onChange){return this.options.onChange(b)}};a.prototype._onLocaleChange=function(){var b;b=this.read.call(this,ko.utils.unwrapObservable(this.value));this.__kb.value_observable(b);if(this.options.onChange){return this.options.onChange(b)}};return a})();Knockback.localizedObservable=function(c,b,a){return new Knockback.LocalizedObservable(c,b,a)};Knockback.Observable=(function(){a.name="Observable";function a(c,d,b){var e,f=this;this.model=c;this.mapping_info=d;this.view_model=b!=null?b:{};if(!this.model){throw new Error("Observable: model is missing")}if(!this.mapping_info){throw new Error("Observable: mapping_info is missing")}if(_.isString(this.mapping_info)||ko.isObservable(this.mapping_info)){this.mapping_info={key:this.mapping_info}}if(!this.mapping_info.key){throw new Error("Observable: mapping_info.key is missing")}this.__kb={};this.__kb._onModelChange=_.bind(this._onModelChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);if(this.mapping_info.hasOwnProperty("write")&&_.isBoolean(this.mapping_info.write)){this.mapping_info=_.clone(this.mapping_info);this.mapping_info.read_only=!this.mapping_info.write}if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this.__kb._onModelLoaded);this.model_ref.bind("unloaded",this.__kb._onModelUnloaded);this.model=this.model_ref.getModel()}this.__kb.value_observable=ko.observable();if(this.mapping_info.localizer){this.__kb.localizer=new this.mapping_info.localizer(this._getCurrentValue())}e=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this._onGetValue,this),write:this.mapping_info.read_only?(function(){throw new Error("Knockback.Observable: "+f.mapping_info.key+" is read only")}):_.bind(this._onSetValue,this),owner:this.view_model}));e.destroy=_.bind(this.destroy,this);e.setToDefault=_.bind(this.setToDefault,this);if(!this.model_ref||this.model_ref.isLoaded()){this.model.bind("change",this.__kb._onModelChange)}return e}a.prototype.destroy=function(){this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);if(this.model){this.__kb._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this.__kb._onModelLoaded);this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.mapping_info=null;this.view_model=null;return this.__kb=null};a.prototype.setToDefault=function(){var b;b=this._getDefaultValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(b);b=this.__kb.localizer()}return this.__kb.value_observable(b)};a.prototype._getDefaultValue=function(){if(!this.mapping_info.hasOwnProperty("default")){return""}if(typeof this.mapping_info["default"]==="function"){return this.mapping_info["default"]()}else{return this.mapping_info["default"]}};a.prototype._getCurrentValue=function(){var b,d,e,g,c,f;if(!this.model){return this._getDefaultValue()}e=ko.utils.unwrapObservable(this.mapping_info.key);d=[e];if(!_.isUndefined(this.mapping_info.args)){if(_.isArray(this.mapping_info.args)){f=this.mapping_info.args;for(g=0,c=f.length;g<c;g++){b=f[g];d.push(ko.utils.unwrapObservable(b))}}else{d.push(ko.utils.unwrapObservable(this.mapping_info.args))}}if(this.mapping_info.read){return this.mapping_info.read.apply(this.view_model,d)}else{return this.model.get.apply(this.model,d)}};a.prototype._onGetValue=function(){var b,f,e,c,d;this.__kb.value_observable();ko.utils.unwrapObservable(this.mapping_info.key);if(!_.isUndefined(this.mapping_info.args)){if(_.isArray(this.mapping_info.args)){d=this.mapping_info.args;for(e=0,c=d.length;e<c;e++){b=d[e];ko.utils.unwrapObservable(b)}}else{ko.utils.unwrapObservable(this.mapping_info.args)}}f=this._getCurrentValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(f);f=this.__kb.localizer()}return f};a.prototype._onSetValue=function(h){var b,e,d,g,c,f;if(this.__kb.localizer){this.__kb.localizer(h);h=this.__kb.localizer.observedValue()}if(this.model){d={};d[ko.utils.unwrapObservable(this.mapping_info.key)]=h;e=typeof this.mapping_info.write==="function"?[h]:[d];if(!_.isUndefined(this.mapping_info.args)){if(_.isArray(this.mapping_info.args)){f=this.mapping_info.args;for(g=0,c=f.length;g<c;g++){b=f[g];e.push(ko.utils.unwrapObservable(b))}}else{e.push(ko.utils.unwrapObservable(this.mapping_info.args))}}if(typeof this.mapping_info.write==="function"){this.mapping_info.write.apply(this.view_model,e)}else{this.model.set.apply(this.model,e)}}if(this.__kb.localizer){return this.__kb.value_observable(this.__kb.localizer())}else{return this.__kb.value_observable(h)}};a.prototype._modelBind=function(b){if(!b){return}b.bind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(b instanceof Backbone.RelationalModel)){b.bind("add",this.__kb._onModelChange);b.bind("remove",this.__kb._onModelChange);return b.bind("update",this.__kb._onModelChange)}};a.prototype._modelUnbind=function(b){if(!b){return}b.unbind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(b instanceof Backbone.RelationalModel)){b.unbind("add",this.__kb._onModelChange);b.unbind("remove",this.__kb._onModelChange);return b.unbind("update",this.__kb._onModelChange)}};a.prototype._onModelLoaded=function(b){this.model=b;this._modelBind(b);return this._updateValue()};a.prototype._onModelUnloaded=function(b){if(this.__kb.localizer&&this.__kb.localizer.destroy){this.__kb.localizer.destroy();this.__kb.localizer=null}this._modelUnbind(b);return this.model=null};a.prototype._onModelChange=function(){if((this.model&&this.model.hasChanged)&&!this.model.hasChanged(ko.utils.unwrapObservable(this.mapping_info.key))){return}return this._updateValue()};a.prototype._updateValue=function(){var b;b=this._getCurrentValue();if(this.__kb.localizer){this.__kb.localizer.observedValue(b);b=this.__kb.localizer()}return this.__kb.value_observable(b)};return a})();Knockback.observable=function(b,c,a){return new Knockback.Observable(b,c,a)};Knockback.Observables=(function(){a.name="Observables";function a(e,g,k,j){var h,i,f,c,d,b;if(!e){throw new Error("Observables: model is missing")}if(!g||!_.isObject(g)){throw new Error("Observables: mappings_info is missing")}this.__kb||(this.__kb={});this.__kb.model=e;this.__kb.mappings_info=g;this.__kb.view_model=_.isUndefined(k)?this:k;if(!_.isUndefined(j)&&j.hasOwnProperty("write")){kb.utils.legacyWarning("Knockback.Observables option.write","0.16.0","Now default is writable so only supply read_only as required");j.read_only=!j.write;delete j.write}if(!_.isUndefined(j)){c=_.isBoolean(j)?j:j.read_only;d=this.__kb.mappings_info;for(f in d){i=d[f];h=_.isString(i);if(h){i=!_.isUndefined(c)?{key:i,read_only:c}:{key:i}}else{if(!_.isUndefined(c)&&!(i.hasOwnProperty("read_only")||i.hasOwnProperty("write"))){i.read_only=c}}if(!i.hasOwnProperty("key")){i.key=f}this[f]=this.__kb.view_model[f]=kb.observable(this.__kb.model,i,this.__kb.view_model)}}else{b=this.__kb.mappings_info;for(f in b){i=b[f];if(i.hasOwnProperty("write")){kb.utils.legacyWarning("Knockback.Observables option.write","0.16.0","Now default is writable so only supply read_only as required")}if(!i.hasOwnProperty("key")){i.key=f}this[f]=this.__kb.view_model[f]=kb.observable(this.__kb.model,i,this.__kb.view_model)}}}a.prototype.destroy=function(){var c,b,d;d=this.__kb.mappings_info;for(b in d){c=d[b];if(this.__kb.view_model[b]){this.__kb.view_model[b].destroy()}this.__kb.view_model[b]=null;this[b]=null}this.__kb.view_model=null;this.__kb.mappings_info=null;return this.__kb.model=null};a.prototype.setToDefault=function(){var d,b,e,c;e=this.__kb.mappings_info;c=[];for(b in e){d=e[b];c.push(this.__kb.view_model[b].setToDefault())}return c};return a})();Knockback.observables=function(c,d,a,b){return new Knockback.Observables(c,d,a,b)};Knockback.TriggeredObservable=(function(){a.name="TriggeredObservable";function a(b,d){var c;this.model=b;this.event_name=d;if(!this.model){throw new Error("Observable: model is missing")}if(!this.event_name){throw new Error("Observable: event_name is missing")}this.__kb={};this.__kb._onValueChange=_.bind(this._onValueChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);if(Backbone.ModelRef&&(this.model instanceof Backbone.ModelRef)){this.model_ref=this.model;this.model_ref.retain();this.model_ref.bind("loaded",this.__kb._onModelLoaded);this.model_ref.bind("unloaded",this.__kb._onModelUnloaded);this.model=this.model_ref.getModel()}this.__kb.value_observable=ko.observable();c=kb.utils.wrappedObservable(this,ko.dependentObservable(_.bind(this._onGetValue,this)));c.destroy=_.bind(this.destroy,this);if(!this.model_ref||this.model_ref.isLoaded()){this._onModelLoaded(this.model)}return c}a.prototype.destroy=function(){kb.utils.wrappedObservable(this).dispose();kb.utils.wrappedObservable(this,null);this.__kb.value_observable=null;if(this.model){this._onModelUnloaded(this.model)}if(this.model_ref){this.model_ref.unbind("loaded",this.__kb._onModelLoaded);this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded);this.model_ref.release();this.model_ref=null}this.options=null;this.view_model=null;return this.__kb=null};a.prototype._onGetValue=function(){return this.__kb.value_observable()};a.prototype._onModelLoaded=function(b){this.model=b;this.model.bind(this.event_name,this.__kb._onValueChange);return this._onValueChange()};a.prototype._onModelUnloaded=function(){if(this.__kb.localizer&&this.__kb.localizer.destroy){this.__kb.localizer.destroy();this.__kb.localizer=null}this.model.unbind(this.event_name,this.__kb._onValueChange);return this.model=null};a.prototype._onValueChange=function(){var b;b=this.__kb.value_observable();if(b!==this.model){return this.__kb.value_observable(this.model)}else{return this.__kb.value_observable.valueHasMutated()}};return a})();Knockback.triggeredObservable=function(a,b){return new Knockback.TriggeredObservable(a,b)};var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Knockback.AttributeConnector=(function(){a.name="AttributeConnector";function a(c,d,b){var e;this.key=d;this.options=b!=null?b:{};kb.utils.wrappedModel(this,c);this.options=_.clone(this.options);this.__kb.value_observable=ko.observable();e=kb.utils.wrappedObservable(this,ko.dependentObservable({read:_.bind(this.read,this),write:_.bind(this.write,this)}));e.destroy=_.bind(this.destroy,this);e.model=_.bind(this.model,this);e.update=_.bind(this.update,this);this.__kb.initializing=true;this.update();this.__kb.initializing=false;return e}a.prototype.destroy=function(){this.__kb.value_observable=null;kb.utils.wrappedObservable(this).dispose();return kb.utils.wrappedObservable(this,null)};a.prototype.read=function(){return this.__kb.value_observable()};a.prototype.write=function(d){var c,b;c=kb.utils.wrappedModel(this);if(!c){return}if(this.options.read_only){if(!this.__kb.initializing){throw"Cannot write a value to a dependentObservable unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters."}}else{b={};b[this.key]=d;return c.set(b)}};a.prototype.model=function(b){var c;c=kb.utils.wrappedModel(this);if(arguments.length===0){return c}if(c===b){return}kb.utils.wrappedModel(this,b);return this.update()};a.inferType=function(b,c){var d,e;e=b.get(c);if(!e){if(!(Backbone.RelationalModel&&(b instanceof Backbone.RelationalModel))){return"simple"}d=_.find(b.getRelations(),function(f){return f.key===c});if(!d){return"simple"}if(d.collectionKey){return"collection"}else{return"model"}}if(e instanceof Backbone.Collection){return"collection"}if((e instanceof Backbone.Model)||(Backbone.ModelRef&&(e instanceof Backbone.ModelRef))){return"model"}return"simple"};a.createByType=function(e,c,d,b){var f;switch(e){case"collection":f=b?_.clone(b):{};if(!(b.view_model||b.view_model_create||b.children||b.create)){f.view_model=kb.ViewModel}if(b.store){b.store.addResolverToOptions(f,c.get(d))}return kb.collectionAttributeConnector(c,d,f);case"model":f=b?_.clone(b):{};if(!f.options){f.options={}}if(!(b.view_model||b.view_model_create||b.children||b.create)){f.view_model=kb.ViewModel}if(b.store){b.store.addResolverToOptions(f.options,c.get(d))}return kb.viewModelAttributeConnector(c,d,f);default:return kb.simpleAttributeConnector(c,d,b)}};a.createOrUpdate=function(f,c,d,b){var g,e;if(f){if(kb.utils.observableInstanceOf(f,kb.AttributeConnector)){if(f.model()!==c){f.model(c)}else{f.update()}}return f}if(!c){return kb.simpleAttributeConnector(c,d,b)}if(b.hasOwnProperty("create")){if(!b.create){throw new Error("Knockback.AttributeConnector: options.create is empty")}return b.create(c,d,b.options||{})}e=c.get(d);if(b.hasOwnProperty("view_model")){if(!b.view_model){throw new Error("Knockback.AttributeConnector: options.view_model is empty")}return new b.view_model(e,b.options||{})}else{if(b.hasOwnProperty("view_model_create")){if(!b.view_model_create){throw new Error("Knockback.AttributeConnector: options.view_model_create is empty")}return b.view_model_create(e,b.options||{})}else{if(b.hasOwnProperty("children")){if(!b.children){throw new Error("Knockback.AttributeConnector: options.children is empty")}if(typeof b.children==="function"){g={view_model:b.children}}else{g=b.children||{}}return kb.collectionAttributeConnector(c,d,g)}}}return this.createByType(this.inferType(c,d),c,d,b)};return a})();Knockback.SimpleAttributeConnector=(function(b){__extends(a,b);a.name="SimpleAttributeConnector";function a(){a.__super__.constructor.apply(this,arguments);return kb.utils.wrappedObservable(this)}a.prototype.destroy=function(){this.current_value=null;return a.__super__.destroy.apply(this,arguments)};a.prototype.update=function(){var d,c,e;c=kb.utils.wrappedModel(this);if(!c){return}e=c.get(this.key);d=this.__kb.value_observable();if(!_.isEqual(d,e)){return this.__kb.value_observable(e)}};a.prototype.write=function(d){var c;c=kb.utils.wrappedModel(this);if(!c){this.__kb.value_observable(d);return}return a.__super__.write.apply(this,arguments)};return a})(Knockback.AttributeConnector);Knockback.simpleAttributeConnector=function(b,c,a){return new Knockback.SimpleAttributeConnector(b,c,a)};Knockback.CollectionAttributeConnector=(function(a){__extends(b,a);b.name="CollectionAttributeConnector";function b(){b.__super__.constructor.apply(this,arguments);return kb.utils.wrappedObservable(this)}b.prototype.destroy=function(){var c;c=this.__kb.value_observable();if(c&&(typeof c.refCount==="function")&&(c.refCount()>0)){c.release()}return b.__super__.destroy.apply(this,arguments)};b.prototype.update=function(){var d,c,e,f=this;c=kb.utils.wrappedModel(this);if(!c){return}e=c.get(this.key);d=this.__kb.value_observable();if(!d){if(this.options.store){return this.__kb.value_observable(this.options.store.resolveValue(e,function(){return kb.collectionObservable(e,f.options)}))}else{return this.__kb.value_observable(kb.collectionObservable(e,this.options))}}else{if(d.collection()!==e){d.collection(e);return this.__kb.value_observable.valueHasMutated()}}};b.prototype.read=function(){var c;c=this.__kb.value_observable();if(c){return c()}else{return}};return b})(Knockback.AttributeConnector);Knockback.collectionAttributeConnector=function(b,c,a){return new Knockback.CollectionAttributeConnector(b,c,a)};Knockback.ViewModelAttributeConnector=(function(b){__extends(a,b);a.name="ViewModelAttributeConnector";function a(){a.__super__.constructor.apply(this,arguments);return kb.utils.wrappedObservable(this)}a.prototype.destroy=function(){var c;c=this.__kb.value_observable();if(c&&(typeof c.refCount==="function")&&(c.refCount()>0)){c.release()}return a.__super__.destroy.apply(this,arguments)};a.prototype.update=function(){var d,c,e,f,g=this;c=kb.utils.wrappedModel(this);if(!c){return}e=c.get(this.key);d=this.__kb.value_observable();if(!d){f=this.options.options?_.clone(this.options.options):{};if(f.store){return this.__kb.value_observable(f.store.resolveValue(e,function(){if(g.options.view_model){return new g.options.view_model(e,f)}else{return g.options.view_model_create(e,f)}}))}else{return this.__kb.value_observable(this.options.view_model?new this.options.view_model(e,f):this.options.view_model_create(e,f))}}else{if(!(d.model&&(typeof d.model==="function"))){throw new Error("Knockback.viewModelAttributeConnector: unknown how to model a view model")}if(d.model()!==e){d.model(e);return this.__kb.value_observable.valueHasMutated()}}};return a})(Knockback.AttributeConnector);Knockback.viewModelAttributeConnector=function(b,c,a){return new Knockback.ViewModelAttributeConnector(b,c,a)};var __hasProp={}.hasOwnProperty,__extends=function(d,b){for(var a in b){if(__hasProp.call(b,a)){d[a]=b[a]}}function c(){this.constructor=d}c.prototype=b.prototype;d.prototype=new c;d.__super__=b.prototype;return d};Knockback.ViewModel_RCBase=(function(b){__extends(a,b);a.name="ViewModel_RCBase";function a(){return a.__super__.constructor.apply(this,arguments)}a.prototype.__destroy=function(){var d,e,c;c=[];for(d in this){e=this[d];if(!e||(d==="__kb")){continue}if(kb.utils.release(e)){c.push(this[d]=null)}else{c.push(void 0)}}return c};return a})(Knockback.RefCountable);Knockback.ViewModel=(function(b){__extends(a,b);a.name="ViewModel";function a(e,d){var g,f,h,c;if(d==null){d={}}a.__super__.constructor.apply(this,arguments);if(Knockback.stats_on){kb.stats.view_models++}if(!d.store_skip_resolve){kb.Store.resolveFromOptions(d,this)}if(d.store){this.__kb.store=d.store}else{this.__kb.store=new kb.Store();this.__kb.store_is_owned=true}this.__kb._onModelChange=_.bind(this._onModelChange,this);this.__kb._onModelLoaded=_.bind(this._onModelLoaded,this);this.__kb._onModelUnloaded=_.bind(this._onModelUnloaded,this);this.__kb.internals=d.internals;this.__kb.requires=d.requires;this.__kb.children=d.children;this.__kb.create=d.create;this.__kb.read_only=d.read_only;kb.utils.wrappedModel(this,e);if(Backbone.ModelRef&&(e instanceof Backbone.ModelRef)){this.__kb.model_ref=e;this.__kb.model_ref.retain();kb.utils.wrappedModel(this,this.__kb.model_ref.getModel());this.__kb.model_ref.bind("loaded",this.__kb._onModelLoaded);this.__kb.model_ref.bind("unloaded",this.__kb._onModelUnloaded)}if(this.__kb.model){this._onModelLoaded(this.__kb.model)}if(!this.__kb.internals&&!this.__kb.requires){return this}f=_.union((this.__kb.internals?this.__kb.internals:[]),(this.__kb.requires?this.__kb.requires:[]));if(!this.__kb.model_ref||this.__kb.model_ref.isLoaded()){f=_.difference(f,_.keys(this.__kb.model.attributes))}for(h=0,c=f.length;h<c;h++){g=f[h];this._updateAttributeConnector(this.__kb.model,g)}}a.prototype.__destroy=function(){var c;c=this.__kb.model;kb.utils.wrappedModel(this,null);this._modelUnbind(c);if(this.__kb.store_is_owned){this.__kb.store.destroy()}this.__kb.store=null;a.__super__.__destroy.apply(this,arguments);if(Knockback.stats_on){return kb.stats.view_models--}};a.prototype.model=function(c){var d;d=kb.utils.wrappedModel(this);if(arguments.length===0){return d}if(c===d){return}if(d){this._onModelUnloaded(d)}if(c){return this._onModelLoaded(c)}};a.prototype._modelBind=function(c){if(!c){return}c.bind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(c instanceof Backbone.RelationalModel)){c.bind("add",this.__kb._onModelChange);c.bind("remove",this.__kb._onModelChange);return c.bind("update",this.__kb._onModelChange)}};a.prototype._modelUnbind=function(c){if(!c){return}c.unbind("change",this.__kb._onModelChange);if(Backbone.RelationalModel&&(c instanceof Backbone.RelationalModel)){c.unbind("add",this.__kb._onModelChange);c.unbind("remove",this.__kb._onModelChange);return c.unbind("update",this.__kb._onModelChange)}};a.prototype._onModelLoaded=function(d){var e,c;kb.utils.wrappedModel(this,d);this._modelBind(d);c=[];for(e in this.__kb.model.attributes){c.push(this._updateAttributeConnector(this.__kb.model,e))}return c};a.prototype._onModelUnloaded=function(d){var e,c;this._modelUnbind(d);kb.utils.wrappedModel(this,null);c=[];for(e in d.attributes){c.push(this._updateAttributeConnector(null,e))}return c};a.prototype._onModelChange=function(){var e,c,d;if(this.__kb.model._changed){c=[];for(e in this.__kb.model.attributes){c.push(this.__kb.model.hasChanged(e)?this._updateAttributeConnector(this.__kb.model,e):void 0)}return c}else{if(this.__kb.model.changed){d=[];for(e in this.__kb.model.changed){d.push(this._updateAttributeConnector(this.__kb.model,e))}return d}}};a.prototype._updateAttributeConnector=function(c,e){var d;d=this.__kb.internals&&_.contains(this.__kb.internals,e)?"_"+e:e;return this[d]=kb.AttributeConnector.createOrUpdate(this[d],c,e,this._createOptions(e))};a.prototype._createOptions=function(d){var c;if(this.__kb.children){if(this.__kb.children.hasOwnProperty(d)){c=this.__kb.children[d];if(typeof c==="function"){c={view_model:c}}c.options={read_only:this.__kb.read_only,store:this.__kb.store};return c}else{if(this.__kb.children.hasOwnProperty("create")){return{create:this.__kb.children.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}}}}}else{if(this.__kb.create){return{create:this.__kb.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}}}}return{read_only:this.__kb.read_only,store:this.__kb.store}};return a})(Knockback.ViewModel_RCBase);Knockback.viewModel=function(b,a){return new Knockback.ViewModel(b,a)};
